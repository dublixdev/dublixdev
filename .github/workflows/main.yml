name: CI va Snake Generatsiya

on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"  # Har kuni soat 00:00 da
  workflow_dispatch:     # Qo'lda ishga tushirish

jobs:
  generate_snake:
    name: Contribution Snake Yaratish
    runs-on: ubuntu-latest
    steps:
      - name: Snake generatsiya
        uses: Platane/snk@v2
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            assets/github-snake.svg
            assets/github-snake-dark.svg?palette=github-dark

      - name: GitHubga Commit qilish
        uses: EndBug/add-and-commit@v9
        with:
          branch: main
          message: "Snake yangilandi üêç"
          add: |
            assets/github-snake.svg
            assets/github-snake-dark.svg
          author_name: GitHub Actions
          author_email: actions@github.com

  php_ci:
    name: PHP CI Pipeline
    runs-on: ubuntu-latest
    needs: generate_snake
    steps:
      - name: Kodni olish
        uses: actions/checkout@v3

      - name: PHP sozlash
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, ctype, xml, json, dom, fileinfo
          coverage: pcov

      - name: Composer Cache
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}

      - name: Dependensiyalarni o'rnatish
        run: composer install -n --prefer-dist --no-progress

      - name: Environment fayl
        run: cp .env.example .env

      - name: Key generatsiya
        run: php artisan key:generate

      - name: Testlarni ishga tushirish
        run: ./vendor/bin/phpunit --coverage-clover clover.xml

      - name: Code Coverage
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: clover.xml
